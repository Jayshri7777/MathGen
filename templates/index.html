{% extends "base.html" %}
{% block content %}

<style>
.ws-container {
    max-width: 1000px;   /* üëà REDUCED from 1040 */
    margin: auto;
    padding: 20px 16px 50px;
}

.ws-card {
    background: rgba(255, 255, 255, 0.55);
    border-radius: 20px;
    padding: 26px;
    box-shadow: 0 12px 28px rgba(0,0,0,0.08);
}

.vertical-or {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    align-self: stretch;   /* stretch ONLY inside grid */
    max-height: 100%;      /* prevent page overflow */

    color: #8a4a4a;
    font-size: 12px;
    font-weight: 600;
    gap: 10px;
}


.vertical-or::before,
.vertical-or::after {
    content: "";
    width: 1px;                /* üëà vertical line */
    flex: 1;                   /* üëà stretches to ends */
    background: #d8a79b;
}



.ws-grid {
    display: grid;
    grid-template-columns: 1fr auto 0.9fr;
    gap: 24px;
    align-items: stretch;
    position: relative;
}



@media (max-width: 900px) {
    .ws-grid {
        grid-template-columns: 1fr;
    }

    .vertical-or {
        flex-direction: row;
    }

    .vertical-or::before,
    .vertical-or::after {
        width: 40px;
        height: 1px;
    }
}



.form-group {
    margin-bottom: 22px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
}

.pretty-select,
.pretty-input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #d8a79b;
}

.file-box {
    background: #fff;
    border-radius: 12px;
    padding: 10px;
    border: 1px dashed #d8a79b;
}

.generate-btn {
    margin-top: 55px;
    display: flex;
    justify-content: center;
}

.generate-btn button {
    background: linear-gradient(135deg, #7a1f2b, #a83246);
    border: none;
    color: white;
    padding: 14px 40px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 999px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(122, 31, 43, 0.35);
}
.ws-card.secondary {
    background: rgba(255, 255, 255, 0.65);
    border: 2px dashed #d8a79b;
    padding: 22px;
    height: fit-content;     /* üëà STOP STRETCHING */
}


.ws-card.secondary h3 {
    font-size: 17px;
    margin: 0 0 8px 0;
    font-weight: 600;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
}
.or-divider {
    display: flex;
    align-items: center;
    gap: 18px;
    margin: 30px 0;
    color: #8a4a4a;
    font-weight: 600;
}

.or-divider::before,
.or-divider::after {
    content: "";
    flex: 1;
    height: 1px;
    background: #d8a79b;
}
.generate-btn button:disabled {
    background: linear-gradient(135deg, #cfa5a5, #e6bcbc);
    cursor: not-allowed;
    opacity: 0.7;
}
.answer-key-bar {
    max-width: 600px;          /* üëà narrower looks better */
    margin: 25px auto;         /* üëà centers it horizontally */
    padding: 16px 24px;
    font-weight: 700;     /* üëà bold */
    font-size: 16px;      /* üëà slightly stronger presence */
    color: #5a1f1f;       
    background: rgba(255, 255, 255, 0.6);
    border-radius: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    display: flex;             /* üëà center contents */
    justify-content: center;
}
.answer-key-bar .checkbox-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transform: scale(1.1);
}

.upload-card {
    display: flex;
    flex-direction: column;
    justify-content: center; /* üëà vertical centering */
    text-align: center;
}


.upload-zone {
    border: 2px dashed #d8a79b;
    border-radius: 18px;
    padding: 22px 18px;
    text-align: center;
    background: rgba(255,255,255,0.4);
}

.upload-icon {
    font-size: 36px;
    margin-bottom: 10px;
}

.upload-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
}

.upload-subtext {
    font-size: 12px;
    color: #7a4a4a;
    margin-bottom: 18px;
}

.upload-btn {
    display: inline-block;
    padding: 10px 18px;
    border-radius: 999px;
    background: linear-gradient(135deg, #7a1f2b, #a83246);
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 14px;
}

.upload-btn:hover {
    opacity: 0.95;
}

.upload-hint {
    font-size: 12px;
    color: #8a5a5a;
}
.page-title {
    font-size: 22px;          /* üëà key change */
    font-weight: 600;
    margin: 0 0 4px 0;
    letter-spacing: 0.15px;
}
.section-title {
    text-align: center;     /* üëà center */
    font-size: 22px;
    font-weight: 700;       /* üëà bold */
    color: #4b1e1e;
    margin-bottom: 6px;
}


.section-desc {
    font-size: 12.5px;
    margin-bottom: 18px;
    color: #7a4a4a;
}
/* ===== PAGE HEADER FIX ===== */
.page-header {
    max-width: 640px;
    margin: 28px auto 28px;   /* üëà adds top gap */
    text-align: center;
}


.page-title {
    font-size: 26px;           /* üëà strong but clean */
    font-weight: 700;
    margin: 0;
    color: #4b1e1e;
}

.page-title span {
    font-size: 22px;
}

.page-subtitle {
    font-size: 14px;
    margin-top: 6px;
    color: #7a4a4a;
    line-height: 1.4;
}
body {
    background-attachment: fixed;
}
.left-panel {
    display: flex;
    flex-direction: column;
}
.action-hint {
    max-width: 650px;
    margin: 30px auto 16px;
    text-align: center;
    font-size: 13px;
    color: #7a4a4a;
    line-height: 1.5;
}
.action-hint strong {
    color: #5a1f1f;
}
.generate-btn.dual {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-top: 24px;
}

/* Button size control */
.generate-btn.dual button {
    min-width: 220px;
    padding: 14px 24px;
    font-size: 15px;
}

/* Primary button slightly stronger */
.generate-btn.dual button:first-child {
    min-width: 240px;
}

/* Prevent full-width stretching */
.generate-btn.dual {
    max-width: 520px;
    margin-left: auto;
    margin-right: auto;
}



.generate-btn.dual .secondary-btn[style*="pointer-events:none"] {
    cursor: not-allowed;
}
/* ===== ACTION FOOTER FIX ===== */
.action-footer {
    margin-top: 32px;
    padding-top: 28px;
    border-top: 1px dashed #d8a79b;
}

.generate-btn.dual {
    margin-top: 20px;   /* üëà reduce vertical gap */
}
@media (max-width: 600px) {
    .generate-btn.dual {
        flex-direction: column;
    }

    .generate-btn.dual button {
        width: 100%;
    }
}
/* ===== RE-DOWNLOAD BUTTON STATES ===== */

/* Default (DISABLED) ‚Äì grey */
.generate-btn.dual .secondary-btn {
    background: linear-gradient(135deg, #cfa5a5, #e6bcbc);
    color: #fff;
    box-shadow: none;
    opacity: 0.65;
    cursor: not-allowed;
}

.generate-btn.dual .secondary-btn:not([style*="pointer-events:none"]) {
    background: linear-gradient(135deg, #7a1f2b, #a83246);
    box-shadow: 0 8px 20px rgba(122, 31, 43, 0.35);
    opacity: 1;
    cursor: pointer;
}

.generate-btn.dual .secondary-btn:not([style*="pointer-events:none"]):hover {
    transform: translateY(-1px);
}


</style>

<div class="page-header">
    <h1 class="page-title">
        Worksheet & Answer Key Generator <span>üß†</span>
    </h1>
    <p class="page-subtitle">
        Generate answer keys or create fresh worksheets in seconds.
    </p>
</div>

<form
    method="POST"
    action="{{ url_for('generate_worksheet') }}"
    enctype="multipart/form-data"
    novalidate
>
<input type="hidden" name="worksheet_type" value="school">



<div class="ws-container">

<div class="ws-card">


    <div class="ws-grid">


        <!-- LEFT: GENERATE NEW WORKSHEET -->
        <!-- LEFT: GENERATE NEW WORKSHEET -->
<div class="left-panel" id="generatorPanel">

    <div id="school-fields">



<h3 class="section-title">Worksheet Generator</h3>
<p class="section-desc">
    Create a new worksheet by selecting topic, difficulty, and format.
</p>

            <!-- GRADE -->
            <div class="form-group">
                <label>Grade</label>
                <input class="pretty-input" value="{{ current_user.grade }}" disabled>
                <input type="hidden" name="grade" id="grade" value="{{ current_user.grade }}">
            </div>

            <!-- BOARD -->
            <div class="form-group">
                <label>Board</label>
                <input class="pretty-input" value="{{ current_user.board }}" disabled>
                <input type="hidden" name="board" id="board" value="{{ current_user.board }}">
            </div>

            <!-- TOPIC -->
            <div class="form-group">
                <label>Topic</label>
                <select class="pretty-select" name="topic" id="topic">
                    <option value="">Loading topics...</option>
                </select>
            </div>

            <!-- SUB TOPIC -->
            <div class="form-group">
    <label>Select Subtopic</label>
    <select class="pretty-select" name="subtopic" id="subtopic" disabled>
        <option value="">Select Sub-Topic</option>
    </select>
</div>


            <!-- DIFFICULTY -->
            <div class="form-group">
                <label>Difficulty</label>
                <select class="pretty-select" name="difficulty">
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>

            <!-- DOWNLOAD FORMAT -->
            <div class="form-group">
                <label>Download As</label>
                <select class="pretty-select" name="school_format" id="school-format">

                    <option value="pdf">PDF</option>
                    <option value="docx">DOCX</option>
                    <option value="txt">TXT</option>
                    <option value="jpg">JPG</option>
                    <option value="png">PNG</option>
                    <option value="gif">GIF</option>
                </select>
            </div>
</div> <!-- END school-fields -->
</div> <!-- END left-panel -->

        <div class="vertical-or">OR</div>


        <!-- RIGHT: UPLOAD EXISTING WORKSHEET ONLY -->
        <div class="ws-card secondary upload-card">
    <h3 class="section-title">Upload Question Paper</h3>
<p class="section-desc">
    Upload an existing worksheet or exam paper to generate answers.
</p>


    <div class="upload-zone">
        <div class="upload-icon">üìÑ</div>

        <p class="upload-title">Upload an existing worksheet</p>
        <p class="upload-subtext">
            Supported formats: PDF, DOCX, JPG, PNG, GIF
        </p>

        <label class="upload-btn">
            Choose File
            <input
  type="file"
  name="worksheet_file"
  id="worksheetFile"
  accept=".pdf,.docx,.jpg,.jpeg,.png,.gif"
  hidden
>

        </label>
        <p id="selectedFileName" style="
  font-size: 13px;
  font-weight: 600;
  color: #6b2b2b;
  margin-top: 8px;
"></p>


        <p class="upload-hint">
            We‚Äôll analyze your worksheet and generate an accurate answer sheet.
        </p>
        </div> <!-- END upload-zone -->



</div> <!-- END ws-card -->


    </div>
    
</div>
<div class="action-footer">

    <div class="answer-key-bar">
        <label class="checkbox-group">
            <input type="checkbox" name="answer_key" value="1">
            Include Answer Key
        </label>
    </div>

    <div class="action-hint">
        <p>
            <strong>Generate New Worksheet</strong> creates a fresh set of questions.
            <br>
            <strong>Re-download Worksheet</strong> keeps the same questions.
        </p>
    </div>

    <div class="generate-btn dual">
        <button
            type="submit"
            name="action"
            value="new"
            id="generateNewBtn"
            disabled
        >
            üÜï Generate New Worksheet
        </button>

<a
    href="#"
    id="regenerateBtn"
    class="secondary-btn"
    style="
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        {% if not has_last_worksheet %}
        pointer-events:none;
        opacity:0.5;
        {% endif %}
    "
>
    üîÅ Re-download Worksheet
</a>

    </div>

</div>

    </div>


</form>
</div>

<!-- ‚úÖ TOPIC AUTO-LOAD SCRIPT -->
<script>
const grade = document.getElementById("grade");
const board = document.getElementById("board");
const topic = document.getElementById("topic");
const difficulty = document.querySelector("select[name='difficulty']");
const worksheetFile = document.querySelector("input[name='worksheet_file']");
const generateNewBtn = document.getElementById("generateNewBtn");
const regenerateBtn = document.getElementById("regenerateBtn");


function checkFormValidity() {
    if (!worksheetFile || !generateNewBtn) return;

    // ‚úÖ UPLOAD MODE ALWAYS WINS
if (worksheetFile.files.length > 0) {
    generateNewBtn.disabled = false;
    return;
}


const schoolValid =
    grade.value &&
    board.value &&
    difficulty.value &&
    document.getElementById("school-format").value &&
    topic.value;

generateNewBtn.disabled = !schoolValid;


}


// Listen to changes
[
    grade,
    board,
    topic,
    difficulty,
    document.getElementById("school-format"),
    worksheetFile,
].filter(Boolean).forEach(el => {
    el.addEventListener("change", checkFormValidity);
});

</script>
<script>
const topicSelect = document.getElementById("topic");
const subTopicSelect = document.getElementById("subtopic");

async function loadSubTopics() {
    const grade = document.getElementById("grade").value;
    const board = document.getElementById("board").value;
    const majorTopic = topicSelect.value;

    subTopicSelect.innerHTML = "<option>Loading sub-topics...</option>";
    subTopicSelect.disabled = true;

    if (!majorTopic) {
        subTopicSelect.innerHTML =
            "<option value=''>Select Sub-Topic (Optional)</option>";
        return;
    }

    try {
        const res = await fetch(
            `/get-minor-topics?grade=${grade}&board=${board}&subject=mathematics&major_topic=${encodeURIComponent(majorTopic)}`
        );

        const data = await res.json();

        subTopicSelect.innerHTML =
            "<option value=''>Select Sub-Topic (Optional)</option>";

        if (data.length === 0) {
            subTopicSelect.innerHTML =
                "<option value=''>No sub-topics available</option>";
            return;
        }

        data.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub;
            opt.textContent = sub;
            subTopicSelect.appendChild(opt);
        });

        subTopicSelect.disabled = false;

    } catch (err) {
        console.error(err);
        subTopicSelect.innerHTML =
            "<option value=''>Error loading sub-topics</option>";
    }
}

topicSelect.addEventListener("change", loadSubTopics);
topicSelect.addEventListener("change", checkFormValidity);

</script>
<script>
async function loadTopics() {

    const grade = document.querySelector("input[name='grade']").value;
    const board = document.querySelector("input[name='board']").value;
    const topicSelect = document.getElementById("topic");

    topicSelect.innerHTML = "<option>Loading topics...</option>";
    topicSelect.disabled = true;

    if (!grade || !board) {
        topicSelect.innerHTML = "<option>Select Grade & Board first</option>";
        return;
    }

try {
    const res = await fetch(`/get-topics?grade=${grade}&board=${board}`, {
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        },
        credentials: "same-origin"
    });

    if (!res.ok) throw new Error("Failed to fetch topics");

    const topics = await res.json();

    topicSelect.innerHTML = "<option value=''>Select Topic</option>";

    if (topics.length === 0) {
        topicSelect.innerHTML = "<option>No topics found</option>";
        topicSelect.disabled = true;
        return;
    }

    topics.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        topicSelect.appendChild(opt);
    });

    topicSelect.disabled = false;   // ‚úÖ ENABLE IT HERE
    checkFormValidity();

} catch (err) {
    console.error(err);
    topicSelect.innerHTML = "<option>Error loading topics</option>";
    topicSelect.disabled = true;
}

}

document.addEventListener("DOMContentLoaded", () => {
    loadTopics();
    checkFormValidity();
    
});
</script>
<script>
document.getElementById("worksheetFile")?.addEventListener("change", function () {
  const fileName = this.files[0]?.name || "";
  document.getElementById("selectedFileName").innerText =
    fileName ? `Selected: ${fileName}` : "";
});
</script>

<script>
const worksheetFileInput = document.getElementById("worksheetFile");
const generatorPanel = document.getElementById("generatorPanel");

function toggleGeneratorByUpload() {
    const hasFile =
        worksheetFileInput &&
        worksheetFileInput.files &&
        worksheetFileInput.files.length > 0;

    if (!generatorPanel) return;

const inputs = generatorPanel.querySelectorAll(
    "input, select, textarea"
);


    inputs.forEach(el => {
        el.disabled = hasFile;
    });

    // Visual feedback (optional but helpful)
    generatorPanel.style.opacity = hasFile ? "0.5" : "1";
    generatorPanel.style.pointerEvents = hasFile ? "none" : "auto";
}

// Run on file change
worksheetFileInput?.addEventListener("change", toggleGeneratorByUpload);
</script>
<script>
const redownloadBtn = document.getElementById("regenerateBtn");
const formatSelect = document.getElementById("school-format");

if (redownloadBtn && formatSelect) {
    redownloadBtn.addEventListener("click", (e) => {
        e.preventDefault();

        const format = formatSelect.value || "pdf";
        window.location.href = `/download-last-worksheet?format=${format}`;
    });
}
</script>

{% endblock %}
