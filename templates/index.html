{% extends "base.html" %}
{% block content %}

<style>
.ws-container {
    max-width: 1000px;   /* ðŸ‘ˆ REDUCED from 1040 */
    margin: auto;
    padding: 20px 16px 50px;
}

.ws-card {
    background: rgba(255, 255, 255, 0.55);
    border-radius: 20px;
    padding: 26px;
    box-shadow: 0 12px 28px rgba(0,0,0,0.08);
}

.vertical-or {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    align-self: stretch;   /* stretch ONLY inside grid */
    max-height: 100%;      /* prevent page overflow */

    color: #8a4a4a;
    font-size: 12px;
    font-weight: 600;
    gap: 10px;
}


.vertical-or::before,
.vertical-or::after {
    content: "";
    width: 1px;                /* ðŸ‘ˆ vertical line */
    flex: 1;                   /* ðŸ‘ˆ stretches to ends */
    background: #d8a79b;
}



.ws-grid {
    display: grid;
    grid-template-columns: 1fr auto 0.9fr;
    gap: 24px;
    align-items: stretch;
    position: relative;
}



@media (max-width: 900px) {
    .ws-grid {
        grid-template-columns: 1fr;
    }

    .vertical-or {
        flex-direction: row;
    }

    .vertical-or::before,
    .vertical-or::after {
        width: 40px;
        height: 1px;
    }
}



.form-group {
    margin-bottom: 22px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
}

.pretty-select,
.pretty-input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #d8a79b;
}

.file-box {
    background: #fff;
    border-radius: 12px;
    padding: 10px;
    border: 1px dashed #d8a79b;
}

.generate-btn {
    margin-top: 55px;
    display: flex;
    justify-content: center;
}

.generate-btn button {
    background: linear-gradient(135deg, #7a1f2b, #a83246);
    border: none;
    color: white;
    padding: 14px 40px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 999px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(122, 31, 43, 0.35);
}
.ws-card.secondary {
    background: rgba(255, 255, 255, 0.65);
    border: 2px dashed #d8a79b;
    padding: 22px;
    height: fit-content;     /* ðŸ‘ˆ STOP STRETCHING */
}


.ws-card.secondary h3 {
    font-size: 17px;
    margin: 0 0 8px 0;
    font-weight: 600;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
}
.or-divider {
    display: flex;
    align-items: center;
    gap: 18px;
    margin: 30px 0;
    color: #8a4a4a;
    font-weight: 600;
}

.or-divider::before,
.or-divider::after {
    content: "";
    flex: 1;
    height: 1px;
    background: #d8a79b;
}
.generate-btn button:disabled {
    background: linear-gradient(135deg, #cfa5a5, #e6bcbc);
    cursor: not-allowed;
    opacity: 0.7;
}
.answer-key-bar {
    max-width: 600px;          /* ðŸ‘ˆ narrower looks better */
    margin: 25px auto;         /* ðŸ‘ˆ centers it horizontally */
    padding: 16px 24px;
    font-weight: 700;     /* ðŸ‘ˆ bold */
    font-size: 16px;      /* ðŸ‘ˆ slightly stronger presence */
    color: #5a1f1f;       
    background: rgba(255, 255, 255, 0.6);
    border-radius: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    display: flex;             /* ðŸ‘ˆ center contents */
    justify-content: center;
}
.answer-key-bar .checkbox-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transform: scale(1.1);
}

.upload-card {
    display: flex;
    flex-direction: column;
    justify-content: center; /* ðŸ‘ˆ vertical centering */
    text-align: center;
}


.upload-zone {
    border: 2px dashed #d8a79b;
    border-radius: 18px;
    padding: 22px 18px;
    text-align: center;
    background: rgba(255,255,255,0.4);
}

.upload-icon {
    font-size: 36px;
    margin-bottom: 10px;
}

.upload-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
}

.upload-subtext {
    font-size: 12px;
    color: #7a4a4a;
    margin-bottom: 18px;
}

.upload-btn {
    display: inline-block;
    padding: 10px 18px;
    border-radius: 999px;
    background: linear-gradient(135deg, #7a1f2b, #a83246);
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 14px;
}

.upload-btn:hover {
    opacity: 0.95;
}

.upload-hint {
    font-size: 12px;
    color: #8a5a5a;
}
.page-title {
    font-size: 22px;          /* ðŸ‘ˆ key change */
    font-weight: 600;
    margin: 0 0 4px 0;
    letter-spacing: 0.15px;
}
.section-title {
    text-align: center;     /* ðŸ‘ˆ center */
    font-size: 22px;
    font-weight: 700;       /* ðŸ‘ˆ bold */
    color: #4b1e1e;
    margin-bottom: 6px;
}


.section-desc {
    font-size: 12.5px;
    margin-bottom: 18px;
    color: #7a4a4a;
}
/* ===== PAGE HEADER FIX ===== */
.page-header {
    max-width: 640px;
    margin: 28px auto 28px;   /* ðŸ‘ˆ adds top gap */
    text-align: center;
}


.page-title {
    font-size: 26px;           /* ðŸ‘ˆ strong but clean */
    font-weight: 700;
    margin: 0;
    color: #4b1e1e;
}

.page-title span {
    font-size: 22px;
}

.page-subtitle {
    font-size: 14px;
    margin-top: 6px;
    color: #7a4a4a;
    line-height: 1.4;
}
body {
    background-attachment: fixed;
}
.left-panel {
    display: flex;
    flex-direction: column;
}



</style>

<div class="page-header">
    <h1 class="page-title">
        Worksheet & Answer Key Generator <span>ðŸ§ </span>
    </h1>
    <p class="page-subtitle">
        Generate answer keys or create fresh worksheets in seconds.
    </p>
</div>

<form
    method="POST"
    action="{{ url_for('generate_worksheet') }}"
    enctype="multipart/form-data"
>

<div class="ws-container">

<div class="ws-card">
    <div class="form-group">
  <label class="required">Worksheet Type</label>

  <label>
    <input type="radio" name="worksheet_type" value="school" checked onchange="toggleWorksheetType()">
    Classes 1â€“12
  </label>

  <label>
    <input type="radio" name="worksheet_type" value="job" onchange="toggleWorksheetType()">
    Job / Competitive Exams
  </label>
</div>

    <div class="ws-grid">


        <!-- LEFT: GENERATE NEW WORKSHEET -->
        <!-- LEFT: GENERATE NEW WORKSHEET -->
<div class="left-panel">
    <div id="school-fields">



<h3 class="section-title">Worksheet Generator</h3>
<p class="section-desc">
    Create a new worksheet by selecting topic, difficulty, and format.
</p>

            <!-- GRADE -->
            <div class="form-group">
                <label>Grade</label>
                <input class="pretty-input" value="{{ current_user.grade }}" disabled>
                <input type="hidden" name="grade" id="grade" value="{{ current_user.grade }}">
            </div>

            <!-- BOARD -->
            <div class="form-group">
                <label>Board</label>
                <input class="pretty-input" value="{{ current_user.board }}" disabled>
                <input type="hidden" name="board" id="board" value="{{ current_user.board }}">
            </div>

            <!-- TOPIC -->
            <div class="form-group">
                <label>Topic</label>
                <select class="pretty-select" name="topic" id="topic" disabled>
                    <option value="">Loading topics...</option>
                </select>
            </div>

            <!-- SUB TOPIC -->
            <div class="form-group">
    <label>Select Subtopic</label>
    <select class="pretty-select" name="subtopic" id="subtopic" disabled>
        <option value="">Select Sub-Topic</option>
    </select>
</div>


            <!-- DIFFICULTY -->
            <div class="form-group">
                <label>Difficulty</label>
                <select class="pretty-select" name="difficulty">
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            </div>

            <!-- DOWNLOAD FORMAT -->
            <div class="form-group">
                <label>Download As</label>
                <select class="pretty-select" name="school_format" id="school-format">

                    <option value="pdf">PDF</option>
                    <option value="docx">DOCX</option>
                    <option value="txt">TXT</option>
                    <option value="jpg">JPG</option>
                    <option value="png">PNG</option>
                    <option value="gif">GIF</option>
                </select>
            </div>
</div> <!-- END school-fields -->

<div id="job-fields" style="display:none;">



    <h3 class="section-title">Job / Competitive Worksheet</h3>
    <p class="section-desc">
        Generate worksheets for competitive exams and job preparation.
    </p>

    <div class="form-group">
        <label class="required">Job Category</label>
        <select class="pretty-select" name="job_type" required>
            <option value="">Select Job Category</option>
            <option value="banking">Banking</option>
            <option value="railway">Railway</option>
            <option value="ssc">SSC</option>
            <option value="upsc">UPSC</option>
            <option value="defence">Defence</option>
            <option value="teaching">Teaching</option>
            <option value="engineering">Engineering</option>
        </select>
    </div>
    <div class="form-group">
    <label class="required">Exam Type</label>
    <select class="pretty-select" name="exam_type" id="exam_type" disabled required>
        <option value="">Select job category first</option>
    </select>
</div>

<div class="form-group">
    <label class="required">Exam Authority</label>
    <select class="pretty-select" name="exam_authority" id="exam_authority" disabled required>
        <option value="">Select exam type first</option>
    </select>
</div>

<div class="form-group">
    <label class="required">Download As</label>
    <select class="pretty-select" name="job_format" id="job-format" required>

        <option value="">Select format</option>
        <option value="pdf">PDF</option>
        <option value="docx">DOCX</option>
        <option value="txt">TXT</option>
        <option value="jpg">JPG</option>
        <option value="png">PNG</option>
<option value="gif">GIF</option>

    </select>
</div>


</div>
</div> <!-- END left-panel -->



        <div class="vertical-or">OR</div>


        <!-- RIGHT: UPLOAD EXISTING WORKSHEET ONLY -->
        <div class="ws-card secondary upload-card">
    <h3 class="section-title">Upload Question Paper</h3>
<p class="section-desc">
    Upload an existing worksheet or exam paper to generate answers.
</p>


    <div class="upload-zone">
        <div class="upload-icon">ðŸ“„</div>

        <p class="upload-title">Upload an existing worksheet</p>
        <p class="upload-subtext">
            Supported formats: PDF, DOCX, JPG, PNG, GIF
        </p>

        <label class="upload-btn">
            Choose File
            <input type="file" name="worksheet_file" hidden>
        </label>

        <p class="upload-hint">
            Weâ€™ll analyze your worksheet and generate an accurate answer sheet.
        </p>
    </div>
</div>

    </div>
</div>


<!-- COMMON ANSWER KEY OPTION -->
<!-- COMMON ANSWER KEY OPTION (THIN) -->
<div class="answer-key-bar">
    <label class="checkbox-group">
        <input type="checkbox" name="answer_key" value="1">
        Include Answer Key
    </label>
</div>




<div class="generate-btn">
    <button type="submit" id="generateBtn" disabled>
    âœ¨ Generate Worksheet
</button>
</div>

</form>
</div>

<!-- âœ… TOPIC AUTO-LOAD SCRIPT -->
<script>
const grade = document.getElementById("grade");
const board = document.getElementById("board");
const topic = document.getElementById("topic");
const difficulty = document.querySelector("select[name='difficulty']");
const worksheetFile = document.querySelector("input[name='worksheet_file']");
const generateBtn = document.getElementById("generateBtn");

function checkFormValidity() {
    const worksheetType =
        document.querySelector("input[name='worksheet_type']:checked").value;

    const format =
        worksheetType === "school"
            ? document.getElementById("school-format")
            : document.getElementById("job-format");

const schoolValid =
    worksheetType === "school" &&
    grade.value &&
    board.value &&
    difficulty.value &&
    format.value &&
    topic.value;


    const jobValid =
        worksheetType === "job" &&
        document.querySelector("select[name='job_type']")?.value &&
        document.querySelector("select[name='exam_type']")?.value &&
        document.querySelector("select[name='exam_authority']")?.value &&
        format.value;

    const uploadValid =
        worksheetFile.files.length > 0;

    generateBtn.disabled = !(schoolValid || jobValid || uploadValid);
}


// Listen to changes
[
    grade,
    board,
    topic,
    difficulty,
    document.getElementById("school-format"),
    document.getElementById("job-format"),
    worksheetFile,
    document.querySelector("select[name='job_type']"),
    document.querySelector("select[name='exam_type']"),
    document.querySelector("select[name='exam_authority']")
].filter(Boolean).forEach(el => {
    el.addEventListener("change", checkFormValidity);
});

// âœ… worksheet type radios
document
  .querySelectorAll("input[name='worksheet_type']")
  .forEach(r => r.addEventListener("change", checkFormValidity));

</script>

<script>
const topicSelect = document.getElementById("topic");
const subTopicSelect = document.getElementById("subtopic");

async function loadSubTopics() {
    const grade = document.getElementById("grade").value;
    const board = document.getElementById("board").value;
    const majorTopic = topicSelect.value;

    subTopicSelect.innerHTML = "<option>Loading sub-topics...</option>";
    subTopicSelect.disabled = true;

    if (!majorTopic) {
        subTopicSelect.innerHTML =
            "<option value=''>Select Sub-Topic (Optional)</option>";
        return;
    }

    try {
        const res = await fetch(
            `/get-minor-topics?grade=${grade}&board=${board}&subject=mathematics&major_topic=${encodeURIComponent(majorTopic)}`
        );

        const data = await res.json();

        subTopicSelect.innerHTML =
            "<option value=''>Select Sub-Topic (Optional)</option>";

        if (data.length === 0) {
            subTopicSelect.innerHTML =
                "<option value=''>No sub-topics available</option>";
            return;
        }

        data.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub;
            opt.textContent = sub;
            subTopicSelect.appendChild(opt);
        });

        subTopicSelect.disabled = false;

    } catch (err) {
        console.error(err);
        subTopicSelect.innerHTML =
            "<option value=''>Error loading sub-topics</option>";
    }
}

topicSelect.addEventListener("change", loadSubTopics);
</script>
<script>
async function loadTopics() {
    const worksheetType =
        document.querySelector("input[name='worksheet_type']:checked").value;

    // ðŸš« Do NOT load school topics in Job mode
    if (worksheetType !== "school") return;

    const grade = document.querySelector("input[name='grade']").value;
    const board = document.querySelector("input[name='board']").value;
    const topicSelect = document.getElementById("topic");

    topicSelect.innerHTML = "<option>Loading topics...</option>";
    topicSelect.disabled = true;

    if (!grade || !board) {
        topicSelect.innerHTML = "<option>Select Grade & Board first</option>";
        return;
    }

    try {
        const res = await fetch(`/get-topics?grade=${grade}&board=${board}`);
        if (!res.ok) throw new Error("Failed to fetch topics");

        const topics = await res.json();

        topicSelect.innerHTML = "<option value=''>Select Topic</option>";

        if (topics.length === 0) {
            topicSelect.innerHTML = "<option>No topics found</option>";
            return;
        }

        topics.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            topicSelect.appendChild(opt);
        });

        topicSelect.disabled = false;
        checkFormValidity();

    } catch (err) {
        console.error(err);
        topicSelect.innerHTML = "<option>Error loading topics</option>";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    toggleWorksheetType();
    loadTopics();
    
});
</script>
<script>
function toggleWorksheetType() {
    const type = document.querySelector(
        "input[name='worksheet_type']:checked"
    ).value;

    const school = document.getElementById("school-fields");
    const job = document.getElementById("job-fields");

    school.style.display = type === "school" ? "block" : "none";
    job.style.display = type === "job" ? "block" : "none";

if (type === "job") {
    topic.disabled = true;
    topic.removeAttribute("name");   // âœ… ADD THIS
    subTopicSelect.removeAttribute("name"); // âœ… ADD THIS
} else {
    topic.disabled = false;
    topic.setAttribute("name", "topic"); // âœ… ADD THIS
    subTopicSelect.setAttribute("name", "subtopic"); // âœ… ADD THIS
    loadTopics();
}


    checkFormValidity();
}

</script>
<script>
const jobExamMap = {
    banking: {
        clerk: ["IBPS Clerk", "SBI Clerk"],
        po: ["SBI PO", "IBPS PO", "RBI Grade B"],
        so: ["IBPS SO"]
    },
    railway: {
        ntpc: ["RRB NTPC"],
        group_d: ["RRB Group D"],
        alp: ["RRB ALP / Technician"]
    },
    ssc: {
        cgl: ["SSC CGL"],
        chsl: ["SSC CHSL"],
        mts: ["SSC MTS"]
    },
    upsc: {
        prelims: ["UPSC CSE"],
        mains: ["UPSC CSE"]
    },
    defence: {
        nda: ["UPSC NDA"],
        cds: ["UPSC CDS"]
    },
    engineering: {
        gate: ["GATE"],
        ese: ["UPSC ESE"]
    }
};

const jobTypeSelect = document.querySelector("select[name='job_type']");
const examTypeSelect = document.getElementById("exam_type");
const authoritySelect = document.getElementById("exam_authority");

jobTypeSelect.addEventListener("change", () => {
    const job = jobTypeSelect.value;

    examTypeSelect.innerHTML = "<option value=''>Select exam type</option>";
    authoritySelect.innerHTML = "<option value=''>Select exam type first</option>";
    examTypeSelect.disabled = true;
    authoritySelect.disabled = true;

    if (!job) return;

    Object.keys(jobExamMap[job]).forEach(exam => {
        const opt = document.createElement("option");
        opt.value = exam;
        opt.textContent = exam.replace("_", " ").toUpperCase();
        examTypeSelect.appendChild(opt);
    });

    examTypeSelect.disabled = false;
});

examTypeSelect.addEventListener("change", () => {
    const job = jobTypeSelect.value;
    const exam = examTypeSelect.value;

    authoritySelect.innerHTML = "<option value=''>Select authority</option>";
    authoritySelect.disabled = true;

    if (!exam) return;

    jobExamMap[job][exam].forEach(auth => {
        const opt = document.createElement("option");
        opt.value = auth;
        opt.textContent = auth;
        authoritySelect.appendChild(opt);
    });

    authoritySelect.disabled = false;
});
worksheetFile.addEventListener("change", checkFormValidity);

</script>

{% endblock %}
